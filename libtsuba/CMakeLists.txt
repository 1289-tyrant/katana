add_library(tsuba STATIC)
set_target_properties(tsuba PROPERTIES EXPORT_NAME tsuba)

set(sources
   src/file.cpp
   src/tsuba.cpp
   src/FileView.cpp
   src/FileFrame.cpp
   src/Errors.cpp
   src/RDG.cpp
   src/s3.cpp
)

target_sources(tsuba PRIVATE ${sources})
target_link_libraries(tsuba PUBLIC galois_support)

find_package(Arrow CONFIG REQUIRED)
if (${ARROW_VERSION} VERSION_LESS 0.17 OR ${ARROW_VERSION} VERSION_GREATER_EQUAL 0.18)
  message(FATAL_ERROR "libarrow must be version 0.17.*; found ${ARROW_VERSION} instead")
endif()

get_filename_component(ARROW_CONFIG_DIR ${Arrow_CONFIG} DIRECTORY)
find_package(Parquet HINTS ${ARROW_CONFIG_DIR})
target_link_libraries(tsuba PUBLIC arrow_shared parquet_shared)

target_include_directories(tsuba PUBLIC
  $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/include>
  $<INSTALL_INTERFACE:include>
)


if (TARGET Boost::Boost)
  # Autogenerated conan module doesn't provide header-only target. Extract one
  # manually.
  get_target_property(include_dirs Boost::Boost INTERFACE_INCLUDE_DIRECTORIES)
  target_include_directories(tsuba PUBLIC ${include_dirs})
else()
  # Standard CMake Boost module
  target_link_libraries(tsuba PUBLIC Boost::boost)
endif()


# The conan generated package name is aws-sdk-cpp while the
# package name when built from source is AWSSDK.
find_package(aws-sdk-cpp QUIET)
if(aws-sdk-cpp_FOUND)
  target_link_libraries(tsuba PRIVATE aws-sdk-cpp::aws-sdk-cpp)
else()
  find_package(AWSSDK REQUIRED COMPONENTS transfer)
  target_link_libraries(tsuba PRIVATE ${AWSSDK_LINK_LIBRARIES})
endif()

add_subdirectory(tests)

install(
  DIRECTORY include/
  DESTINATION "${CMAKE_INSTALL_INCLUDEDIR}"
  COMPONENT dev
  FILES_MATCHING PATTERN "*.h"
)

install(TARGETS tsuba
  EXPORT GaloisTargets
  LIBRARY
    DESTINATION "${CMAKE_INSTALL_LIBDIR}"
    COMPONENT lib
  ARCHIVE
    DESTINATION "${CMAKE_INSTALL_LIBDIR}"
    COMPONENT lib
  INCLUDES DESTINATION "${RELATIVE_INCLUDE_FROM_INSTALL_PREFIX}"
)
